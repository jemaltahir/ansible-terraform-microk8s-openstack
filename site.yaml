---
# Run Terraform, collect output and build inventory
- name: Run Terraform and build inventory
  hosts: localhost
  roles:
  - terraform

# Now wait until all machines are readable
- name: Wait for all machines to become ready
  hosts: all
  gather_facts: no
  tasks:
  - name: Wait for machine to become reachable
    wait_for_connection:
      delay: 30
      sleep: 10

- name: Install Microk8s
  hosts:
  - master
  - compute
  roles:
  - microk8s-install

- name: Install microk8s-master
  hosts: master
  roles:
  - microk8s-master

- name: Install microk8s-nodes
  hosts: compute
  roles:
  - microk8s-nodes

- name: Install microk8s-nfs
  hosts: nfs
  roles:
  - microk8s-nfs

- name: Install the CSI driver for NFS
  hosts: master
  collections:
  - kubernetes.core
  - community.kubernetes
  - cloud.common
  roles:
  - microk8s-csi-driver
